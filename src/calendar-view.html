<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="calendar-appointment.html">

<dom-module id="calendar-view">

  <template>

    <style>
      :host {
        display: block;
      }
      
      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      .mark {
        margin-right: 10px;
        padding-right: 10px;
        padding-top: 0px;
        padding-bottom: 0px;
        padding-left: 10px;
        border-right: solid 2px black;
      }
      paper-material {
        display: inline-block;
        background: white;
        box-sizing: border-box;
        padding: 16px;
      }
      .timeColumn {
        
      }
      .titleColumn {
        font-weight: bolder;
        text-align: right;
      }
      div.timeColumn div {
        margin-top: 26px;
      }
      .time {
        border-bottom: 4px solid silver;
        height: 100px;
      }
      .time30 {
        border-bottom: 4px solid silver;
        height: 100px;
      }
      
      @media (max-width: 600px) {
        .dayTab {
          width: 100%;
          margin: 0px;
        }
        .timeTab {
          width: 100px;
          margin: 0px;
        }
      }
      
      @media (min-width: 601px) {
        .dayTab {
          width: 300px;
          margin: 8px;
        }
        .timeTab {
          width: 150px;
          margin: 8px;
        }
      }
    </style>
    
    <style is="custom-style" include="shared-styles"></style>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>

    <iron-ajax url="data.json" last-response="{{data}}" on-response="saveOriginalData" auto></iron-ajax>
    
    <div id="listArea" class="layout left-justified horizontal">
      <paper-material class="timeTab" elevation="4">
        <h1>&nbsp;</h1>
        <div class="layout vertical titleColumn timeColumn">
          <template is="dom-repeat" items="{{data.timeframes}}">
            <div class="time">[[item]]</div>
            <div class="time30">30</div>
          </template>
        </div>
      </paper-material>
      
      <template is="dom-repeat" items="{{reducedData}}" as="days">
        <paper-material class="dayTab" elevation="3">
          <h1>[[days.day]] - [[days.date]]</h1>
          <div class="layout vertical timeColumn">
            <template is="dom-repeat" items="{{days.agenda}}" as="hours">
              <calendar-appointment blocs="[[hours.blocs]]" displayed-name="[[hours.name]]" location="[[hours.location]]">
              </calendar-appointment>
            </template>
          </div>
        </paper-material>
      </template>
    </div>

  </template>

  <script>

    Polymer({

      is: 'calendar-view',
      
      behaviors: [
        Polymer.IronResizableBehavior
      ],
      
      properties: {

        data: {
          type: Array,
          notify: true,
          observer: '_dataChanged'
        },
        originalData: {
          type: Array,
          notify: true
        },
        reducedData: {
          type: Array,
          notify: true
        },
        listItemWidth: {
          type: Number,
          notify: true,
          value: 300
        }

      },
      
      listeners: {
        'iron-resize': '_onListResize'
      },
      
      attached: function() {
        console.log('Attached has been called.');
        //this.$.theList.addEventListener('iron-resize', this._onListResize.bind(this));
      },
      _onListResize: function() {
        console.log('List resized fired.');
        if (this.originalData) {
          console.log('Original data not empty.');
          var w = this.$.listArea.offsetWidth;
          // We need to determine how much we can resize here.
          // And take a certain percentage as security.
          var ratio = Math.floor(w / this.listItemWidth);
          console.log('Found ratio: ' + ratio);
          // This code is stupid.
          if (ratio < 1) {
            ratio = 1;
          }
          if (ratio >= 1) {
            var max = ratio;
            if (max > this.originalData.length) {
              max = this.originalData.length;
            }
            console.log('Going up to ' + max);
            var nd = new Array();
            for (var i = 0; i < max; i++) {
              nd.push(this.originalData[i]);
            }
            this.reducedData = nd;
          }
        }
      },
      _dataChanged: function() {
        //console.log('Data changed fired.');
      },
      saveOriginalData: function(e) {
        console.log('Saving original data...');
        this.originalData = new Array();
        this.reducedData = new Array();
        console.log(e.detail.response);
        for (var i = 0; i < e.detail.response.days.length; i++) {
          this.originalData.push(e.detail.response.days[i]);
          this.reducedData.push(e.detail.response.days[i]);
        }
        this._onListResize();
      }

    });

  </script>

</dom-module>
